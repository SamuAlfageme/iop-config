---
  apiVersion: helm.fluxcd.io/v1
  kind: HelmRelease
  metadata:
    name: cern-iop-staging
    namespace: staging
    annotations:
      fluxcd.io/automated: "true"
  spec:
    releaseName: cern-iop-staging
    chart:
      # TODO(SamuAlfageme):
      # Replace with HelmRelease.sepc.{repository, name, version}
      git: https://github.com/SamuAlfageme/sciencemeshcharts.git
      path: iop
      ref: iop_ingress
    values:
      revad:
        configFiles:
          # Standalone https://raw.githubusercontent.com/cs3org/reva/master/examples/standalone/standalone.toml
          revad.toml: |
            [grpc.services.gateway]
            datagateway = "https://sciencemesh.cernbox.cern.ch/iop/datagateway"
            [grpc.services.storageregistry]
            [grpc.services.storageprovider]
            data_server_url = "https://sciencemesh.cernbox.cern.ch/iop/data"
            [grpc.services.authprovider]
            [grpc.services.authregistry]
            [grpc.services.userprovider]
            [grpc.services.usershareprovider]
            [grpc.services.publicshareprovider]
            [grpc.services.ocmcore]
            [grpc.services.ocmshareprovider]
            [grpc.services.ocminvitemanager]
            [grpc.services.ocmproviderauthorizer]

            [http.services.dataprovider]
            [http.services.prometheus]
            [http.services.ocmd]
          # Users https://raw.githubusercontent.com/cs3org/reva/master/examples/ocm-partners/users-cern.json
          users.json: |
            [
              {
                "id": {
                  "opaque_id": "ishank1234",
                  "idp": "https://cern.ch"
                },
                "username": "ishank",
                "secret": "ishankpass",
                "mail": "ishank@cern.ch",
                "display_name": "Ishank Arora",
                "groups": ["sailing-lovers", "violin-haters", "physics-lovers"]
              },
              {
                "id": {
                  "opaque_id": "hugo5678",
                  "idp": "https://cern.ch"
                },
                "username": "hugo",
                "secret": "hugopass",
                "mail": "hugo@cern.ch",
                "display_name": "Hugo Gonzalez Labrador",
                "groups": ["radium-lovers", "polonium-lovers", "physics-lovers"]
              },
              {
                "id": {
                  "opaque_id": "samuel9876",
                  "idp": "https://cern.ch"
                },
                "username": "samuel",
                "secret": "samuelpass",
                "mail": "samuel@cern.ch",
                "display_name": "Samuel Alfageme Sainz",
                "groups": ["quantum-lovers", "philosophy-haters", "physics-lovers"]
              }
            ]
          # Providers https://raw.githubusercontent.com/cs3org/reva/master/examples/ocm-partners/providers.demo.json
          ocm-providers.json: |
            [
              {
                "name": "cernbox",
                "full_name": "CERNBox",
                "organization": "CERN",
                "domain": "https://cern.ch",
                "homepage": "https://cernbox.web.cern.ch",
                "description": "CERNBox provides cloud data storage to all CERN users.",
                "services": [
                  {
                    "endpoint": {
                      "type": {
                        "name": "OCM",
                        "description": "CERNBox Open Cloud Mesh API"
                      },
                      "name": "CERNBox - OCM API",
                      "path": "https://sciencemesh.cernbox.cern.ch/iop/ocm/",
                      "isMonitored": true
                    },
                    "api_version": "0.0.1",
                    "host": "https://sciencemesh.cernbox.cern.ch/iop/"
                  }
                ]
              },
              {
                "name": "oc-cesnet",
                "full_name": "ownCloud@CESNET",
                "organization": "CESNET",
                "domain": "https://cesnet.cz",
                "homepage": "https://owncloud.cesnet.cz",
                "description": "OwnCloud has been designed for individual users.",
                "services": [
                  {
                    "endpoint": {
                      "type": {
                        "name": "OCM",
                        "description": "CESNET Open Cloud Mesh API"
                      },
                      "name": "CESNET - OCM API",
                      "path": "https://sciencemesh.cesnet.cz/iop/ocm/",
                      "isMonitored": true
                    },
                    "api_version": "0.0.1",
                    "host": "https://sciencemesh.cesnet.cz/iop/"
                  }
                ]
              },
              {
                "name": "uni-muenster",
                "full_name": "WWU University of Muenster",
                "organization": "University of Muenster",
                "domain": "https://uni-muenster.de",
                "homepage": "https://uni-muenster.de",
                "description": "WWU provides cloud storage to its students, faculty and researchers.",
                "services": [
                  {
                    "endpoint": {
                      "type": {
                        "name": "OCM",
                        "description": "WWU Open Cloud Mesh API"
                      },
                      "name": "WWU - OCM API",
                      "path": "https://sciencemesh-test.uni-muenster.de/api/ocm/",
                      "isMonitored": true
                    },
                    "api_version": "0.0.1",
                    "host": "https://sciencemesh-test.uni-muenster.de/api/"
                  }
                ]
              },
              {
                "name": "cubbit",
                "full_name": "Cubbit",
                "organization": "Cubbit",
                "domain": "https://cubbit.io",
                "homepage": "https://cubbit.io",
                "description": "Cubbit provides distributed storage over a P2P network.",
                "services": [
                  {
                    "endpoint": {
                      "type": {
                        "name": "OCM",
                        "description": "Cubbit Open Cloud Mesh API"
                      },
                      "name": "Cubbit - OCM API",
                      "path": "https://sciencemesh.cubbit.io/ocm/",
                      "isMonitored": true
                    },
                    "api_version": "0.0.1",
                    "host": "https://sciencemesh.cubbit.io/"
                  }
                ]
              },
              {
                "name": "ailleron",
                "full_name": "Ailleron - Software Mind",
                "organization": "Ailleron",
                "domain": "https://ailleron.com",
                "homepage": "https://ailleron.com",
                "description": "Ailleron is a Polish IT company providing software and storage solutions to its clients.",
                "services": [
                  {
                    "endpoint": {
                      "type": {
                        "name": "OCM",
                        "description": "Ailleron Open Cloud Mesh API"
                      },
                      "name": "Ailleron - OCM API",
                      "path": "https://cs3mesh.softwaremind.com/iop/ocm/",
                      "isMonitored": true
                    },
                    "api_version": "0.0.1",
                    "host": "https://cs3mesh.softwaremind.com/iop/"
                  }
                ]
              },
              {
                "name": "surfsara",
                "full_name": "Surfsara",
                "organization": "Surfsara",
                "domain": "https://surfsara.nl",
                "homepage": "https://surfsara.nl",
                "description": "OwnCloud has been designed for individual users.",
                "services": [
                  {
                    "endpoint": {
                      "type": {
                        "name": "OCM",
                        "description": "Surfsara Open Cloud Mesh API"
                      },
                      "name": "Surfsara - OCM API",
                      "path": "https://app.cs3mesh-iop.k8s.surfsara.nl/iop/ocm/",
                      "isMonitored": true
                    },
                    "api_version": "0.0.1",
                    "host": "https://app.cs3mesh-iop.k8s.surfsara.nl/iop/"
                  }
                ]
              }
            ]
      ingress:
        enabled: true
        services:
          grpc:
            hostname: sciencemesh.cernbox.cern.ch
            path: /
            annotations:
              kubernetes.io/ingress.class: nginx
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
            tls:
              - secretName: cernbox-wildcard
                hosts:
                  - sciencemesh.cernbox.cern.ch
          http:
            hostname: sciencemesh.cernbox.cern.ch
            path: /iop(/|$)(.*)
            annotations:
              kubernetes.io/ingress.class: nginx
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              nginx.ingress.kubernetes.io/rewrite-target: /$2
            tls:
              - secretName: cernbox-wildcard
                hosts:
                  - sciencemesh.cernbox.cern.ch

